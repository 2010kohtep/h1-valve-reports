# Incorrectly formed SVC message may cause arbitrary code injection

## Introduction

Hey. There is a vulnerability in GoldSource Engine that allows to execute arbitrary assembler code on the client using the network message **svc_sendextrainfo**.

## Description

The problem lies in function **FileSystem_AddFallbackGameDir**, which is called by the message handler **CL_Set_ServerExtraInfo**. The **FileSystem_AddFallbackGameDir** function passes a string that comes in message **svc_sendextrainfo** and if it is long enough (260 characters in Windows and 4096 in Linux), then it will go outside **temp** buffer using **sprintf** function and set new return address on stack to the code that specified in network packet.

It should be noted that only players who use non-english language are vulnerable. Otherwise, **sprintf** function will not be called and no overflow will occur.

It is also worth noting that the probability of passing control to it's own code is reduced due to the fact that an attacker needs to know "alignment" in order to record the correct address. This dependency is created by the game base directory, for example, **C:\Games\Steam\steamapps\common\Half-Life**. For this directory, the alignment must be **2**. However, since the range of values ​​is only 0 to 3, the attacker can simply try to guess the alignment and with a probability of 25% the result will be successful.

On the other hand, this exploit can work on any operating system without using tricks like NOP sled, since the shellcode is stored not on the stack, but in the data section, the address of which is always the same from OS to OS.

With **sprintf** it is not possible to write the return address to the code that is stored on the stack, since the stack address has a zero character. Therefore, the shellcode is stored in the **net_message_buffer** itself, and the return address will point to this variable.

## How to reproduce

As always, to demonstrate the vulnerability, I implemented compiler of corrupted network data, which could lead to buffer overflow and shellcode execution. The data generated by the compiler will be written to file **msg.bin**. This data must be sent to client from server side.

The attacker may not use HLDS, but implement his own, simplified version of the server using Berkeley sockets, which will process all out-of-band packets from the client side and will look like a normal HLDS server, and when player connected to it - send data from **msg.bin**, thereby causing buffer overflow and shellcode execution. If necessary, I can design such application and show that it will work.

## Possible Solutions

Use **sprintf_s** instead of **sprintf**, or check the length of the argument **pGameDir** and if it is greater than MAX_PATH, then exit the function with result 0.

## Impact

An attacker can organize a massive infection of non-english-speaking players using a game server with high players traffic, or he can try to infect single victim by inviting it to his exploitable server.